/* ============================================
            CSS VARIABLES
      Set by JavaScript per character/message
   ============================================ */

.mes.has-avatar-banner {
  --banner-height: 15vh;
  --banner-font-size: 2.25rem;
  --banner-name-padding-tb: 0em;
  --banner-name-padding-lr: 0em;
  --banner-accent-rgb: 231, 159, 168;
  --banner-font-family: "Caveat", cursive;
}

/* ============================================
            BANNER STANDARD STYLE
   ============================================ */

.avatar-banner {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: var(--banner-height);
  background-image: var(--banner-url);
  background-position: top center;
  background-repeat: no-repeat;
  background-size: cover;
  mask-image: linear-gradient(to bottom, black 60%, rgba(0, 0, 0, 0) 100%);
  mask-size: 100% 100%;
  mask-repeat: no-repeat;
  -webkit-mask-image: linear-gradient(to bottom, black 60%, rgba(0, 0, 0, 0) 100%);
  -webkit-mask-size: 100% 100%;
  -webkit-mask-repeat: no-repeat;
  z-index: 2;
  pointer-events: none;
}

/* Message Container - Base styling (no padding) */
#chat .mes.has-avatar-banner:not(.moonlit-banner) {
  position: relative;
  background:
      linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0) 90%, rgba(var(--banner-accent-rgb), 0.5) 100%),
      var(--SmartThemeBlurTintColor);
  border: rgba(var(--banner-accent-rgb), 0.7) solid 2px !important;
  box-shadow: 3px 3px 10px rgba(var(--banner-accent-rgb), 0.25) !important;
  overflow: visible !important;
}

/* Message Container - Padding ONLY when banner image exists */
#chat .mes.has-avatar-banner:not(.moonlit-banner):has(.avatar-banner) {
  padding: calc(var(--banner-height) * 0.8) 1.5vw 1vh !important;
}

/* Content Layering */
.mes.has-avatar-banner .mes_block,
.mes.has-avatar-banner .mes_text,
.mes.has-avatar-banner .ch_name,
.mes.has-avatar-banner .avatar {
  position: relative;
  z-index: 3;
}

.mes.has-avatar-banner .ch_name,
.mes.has-avatar-banner .mes_block {
  overflow: visible !important;
}

/* Character/User Name Styling */
#chat .mes.has-avatar-banner .name_text {
  display: inline-flex !important;
  align-items: baseline;
  font-size: var(--banner-font-size) !important;
  font-family: var(--banner-font-family) !important;
  font-style: italic;
  line-height: 1.2 !important;
  text-align: left;
  padding: var(--banner-name-padding-tb) var(--banner-name-padding-lr) !important;
  padding-right: 5px !important;
  background: linear-gradient(to bottom, 
      rgba(255, 255, 255, 0.8),
      rgba(var(--banner-accent-rgb), 1)
  ) !important;
  -webkit-background-clip: text !important;
  background-clip: text !important;
  -webkit-text-fill-color: transparent !important;
  color: transparent !important;
  
  /* Soft glow effect */
  text-shadow: 0 0 5px rgba(var(--banner-accent-rgb), 1),
               0 0 1px rgba(255, 255, 255, 1) !important;
  overflow: visible !important;
  white-space: normal !important;
  min-height: 1.2em !important;
}

/* Icons and timestamp styling */
.mes.has-avatar-banner .name_text img,
.mes.has-avatar-banner .name_text span,
.mes.has-avatar-banner .name_text svg,
.mes.has-avatar-banner .icon-svg,
.mes.has-avatar-banner .timestamp {
  fill: currentColor;
  height: 14px;
  aspect-ratio: 1;
  place-self: unset;
  margin-right: 5px;
  white-space: nowrap;
}

.mes.has-avatar-banner .mes_buttons,
.mes.has-avatar-banner .extraMesButtons{
    position: relative;
    gap: 4px;
    flex-wrap: wrap;
    justify-content: flex-start;
    overflow: visible;
    align-items: center;
}

/* Message buttons styling */
.mes.has-avatar-banner .mes_button,
.mes.has-avatar-banner .extraMesButtons > div {
  place-self: center baseline;
  align-self: center;
  font-size: 14px;
  padding: 5px;
  margin-left: 3px;
  border-radius: 50%;
  background: linear-gradient(to bottom,
      rgba(var(--banner-accent-rgb), 0.8),
      rgba(255, 255, 255, 0.5)
  );
  color: rgba(255, 255, 255, 0.9);
  box-shadow: 0 0 5px rgba(var(--banner-accent-rgb), 0.8);
  transition: all 0.3s ease-in-out;
}

/* Bubble Mode Adjustments */
body.bubblechat #chat .mes.has-avatar-banner:not(.moonlit-banner) .avatar-banner {
    border-radius: 10px;
}

/* Hide avatar when banner is present (Standard) */
#chat .mes.has-avatar-banner:not(.moonlit-banner) .avatar {
  display: none !important;
}

/* ============================================
          PANEL BANNER (Standard Theme)
   ============================================ */

body.has-panel-banner #CharListButtonAndHotSwaps {
  margin-bottom: 150px;
}

body.has-panel-banner #CharListButtonAndHotSwaps + hr {
  display: none !important;
}

body.big-avatars.has-panel-banner #right-nav-panel-tabs::after {
  top: 120px;
}

body.has-panel-banner #right-nav-panel-tabs::after {
  content: "";
  position: absolute;
  top: 90px;
  left: 0;
  width: 100%;
  height: 150px;
  background: var(--panel-banner-url) top center no-repeat;
  background-size: cover;
  mask-image: linear-gradient(to bottom, black 60%, rgba(0,0,0,0) 100%);
  mask-size: 100% 100%;
  mask-repeat: no-repeat;
  -webkit-mask-image: linear-gradient(to bottom, black 60%, rgba(0,0,0,0) 100%);
  -webkit-mask-size: 100% 100%;
  -webkit-mask-repeat: no-repeat;
  pointer-events: none;
  z-index: -1;
}

/* ============================================
          MOONLIT ECHOES BANNER
   ============================================ */

/* Message Block - Base styling (no padding) */
.mes.has-avatar-banner.moonlit-banner .mes_block {
  position: relative;
  background:
    linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0) 90%, rgba(var(--banner-accent-rgb), 0.5) 100%),
    var(--SmartThemeBlurTintColor);
  border: rgba(var(--banner-accent-rgb), 0.7) solid 2px !important;
  box-shadow: 3px 3px 10px rgba(var(--banner-accent-rgb), 0.25) !important;
  overflow: visible !important;
}

/* Message Block - Padding ONLY when banner image exists */
.mes.has-avatar-banner.moonlit-banner:has(.avatar-banner) .mes_block {
  padding: calc(var(--banner-height) * 0.8) 1.5vw 1vh !important;
}

/* Banner Element */
.mes.has-avatar-banner.moonlit-banner .avatar-banner {
  z-index: 1;
  height: var(--banner-height) !important;
  border-top-left-radius: inherit;
  border-top-right-radius: inherit;
  overflow: hidden;
}

/* Content Layering */
.mes.has-avatar-banner.moonlit-banner .mes_block,
.mes.has-avatar-banner.moonlit-banner .mes_text,
.mes.has-avatar-banner.moonlit-banner .ch_name {
  position: relative;
  z-index: 2;
  overflow: visible !important;
}

/* Character/User Name Styling */
#chat .mes.has-avatar-banner.moonlit-banner .name_text {
  display: inline-flex !important;
  align-items: baseline;
  font-size: var(--banner-font-size) !important;
  font-family: var(--banner-font-family) !important;
  font-style: italic;
  line-height: 1.2 !important;
  text-align: left;
  padding: var(--banner-name-padding-tb) var(--banner-name-padding-lr) !important;
  padding-right: 5px !important;
  
  /* Gradient text color */
  background: linear-gradient(to bottom, 
      rgba(255, 255, 255, 0.8),
      rgba(var(--banner-accent-rgb), 1)
  ) !important;
  -webkit-background-clip: text !important;
  background-clip: text !important;
  -webkit-text-fill-color: transparent !important;
  color: transparent !important;
  
  /* Soft glow effect */
  text-shadow: 0 0 5px rgba(var(--banner-accent-rgb), 1),
               0 0 1px rgba(255, 255, 255, 1) !important;
  overflow: visible !important;
  white-space: normal !important;
  min-height: 1.2em !important;
}

/* Icons and timestamp styling */
.mes.has-avatar-banner.moonlit-banner .name_text img,
.mes.has-avatar-banner.moonlit-banner .name_text span,
.mes.has-avatar-banner.moonlit-banner .name_text svg,
.mes.has-avatar-banner.moonlit-banner .icon-svg,
.mes.has-avatar-banner.moonlit-banner .timestamp {
  fill: currentColor;
  height: 0.875rem;
  aspect-ratio: 1;
  place-self: unset;
  margin-right: 5px;
  white-space: nowrap;
}

/* Message buttons container */
.mes.has-avatar-banner.moonlit-banner .mes_buttons,
.mes.has-avatar-banner.moonlit-banner .extraMesButtons {
  position: relative;
  gap: 4px;
  flex-wrap: wrap;
  justify-content: flex-start;
  overflow: visible;
  align-items: center;
}

/* Message buttons styling */
.mes.has-avatar-banner.moonlit-banner .mes_button,
.mes.has-avatar-banner.moonlit-banner .extraMesButtons > div {
  place-self: center baseline;
  align-self: center;
  font-size: 0.875rem;
  padding: 5px;
  margin-left: 3px;
  border-radius: 50%;
  background: linear-gradient(to bottom,
      rgba(var(--banner-accent-rgb), 0.8),
      rgba(255, 255, 255, 0.5)
  );
  color: rgba(255, 255, 255, 0.9);
  box-shadow: 0 0 5px rgba(var(--banner-accent-rgb), 0.8);
  transition: all 0.3s ease-in-out;
}

/* User messages in Moonlit */
html body .mes[is_user="true"].moonlit-banner .mes_block,
.mes[is_user="true"].moonlit-banner .mes_block {
  background:
    linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0) 90%, rgba(var(--banner-accent-rgb), 0.5) 100%),
    var(--SmartThemeBlurTintColor);
}

/* Hide avatar in Moonlit mode */
#chat .mes.has-avatar-banner.moonlit-banner .avatar {
  display: none !important;
}

/* Fix timestamp icons in Moonlit */
#chat .mes.has-avatar-banner.moonlit-banner .timestamp,
#chat .mes.has-avatar-banner.moonlit-banner .icon-svg,
#chat .mes.has-avatar-banner.moonlit-banner .timestamp-icon {
  aspect-ratio: auto !important;
  place-self: auto !important;
  margin-right: 0 !important;
}

/* Fix for Moonlit Echoes Popup Buttons (Firefox Compatibility) */
.popup.avatar-banner-popup {
  box-sizing: border-box !important;
  max-width: 800px !important;
  width: 95% !important;
  max-height: 95dvh !important;
}

.popup.avatar-banner-popup .popup-body {
  display: flex !important;
  flex-direction: column !important;
  overflow: visible !important;
}

.popup.avatar-banner-popup .popup-content {
  flex-grow: 1 !important;
  min-height: 0 !important;
  overflow-y: auto !important;
}

.popup.avatar-banner-popup .popup-controls {
  flex-shrink: 0 !important;
  display: flex !important;
  justify-content: center !important;
  padding: 10px 0 !important;
}

/* ============================================
          PANEL BANNER (Moonlit Echoes)
   ============================================ */

body.has-panel-banner-moonlit #CharListButtonAndHotSwaps {
  margin-bottom: 150px !important;
}

body.has-panel-banner-moonlit #CharListButtonAndHotSwaps + hr {
  display: none !important;
}

body.big-avatars.has-panel-banner-moonlit #right-nav-panel-tabs::after {
  top: 140px;
}

body.has-panel-banner-moonlit #right-nav-panel-tabs::after {
  content: "";
  position: absolute;
  top: 110px;
  left: 0;
  width: 100%;
  height: 150px;
  background: var(--panel-banner-url) top center no-repeat;
  background-size: cover;
  mask-image: linear-gradient(to bottom, black 60%, rgba(0,0,0,0) 100%);
  mask-size: 100% 100%;
  mask-repeat: no-repeat;
  -webkit-mask-image: linear-gradient(to bottom, black 60%, rgba(0,0,0,0) 100%);
  -webkit-mask-size: 100% 100%;
  -webkit-mask-repeat: no-repeat;
  pointer-events: none;
  z-index: -1;
}

/* ============================================
            SETTINGS PANEL STYLES
   ============================================ */

.avatar-banner-settings .inline-drawer-content {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding-bottom: 10px;
}

.avatar-banner-settings .checkbox_label {
  display: inline-flex !important;
  align-items: center;
  gap: 6px;
  cursor: pointer;
}

.avatar-banner-settings .checkbox_label input[type="checkbox"] {
  flex-shrink: 0;
  margin: 0;
}

.avatar-banner-grid-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.avatar-banner-font-row {
  display: flex;
  align-items: center;
  gap: 6px;
}

.avatar-banner-font-row input[type="text"].text_pole {
  flex: 1;
  margin: 0;
}

.avatar-banner-inline {
  display: flex;
  align-items: center;
  gap: 6px;
}

.avatar-banner-inline.disabled,
.avatar-banner-font-row.disabled,
.avatar-banner-grid-row .disabled,
.avatar-banner-grid-row.disabled {
  opacity: 0.5;
  pointer-events: none;
}

.avatar-banner-grid-row input[type="text"].text_pole {
  margin: 0;
}

#avatar_banner_button,
#persona_banner_button {
  cursor: pointer;
}
